<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/task_status.js" defer></script>
</head>
<body>
<div class="container task-page">
    <header class="task-header">
        <a href="/" class="link-back">‚Üê –ù–∞–∑–∞–¥ –∫ —Ñ–æ—Ä–º–µ</a>
        <h1>–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏</h1>
        <div class="status-row">
            <span class="status-chip status-{{ task.status.lower() }}">{{ task.status }}</span>
            <span class="task-id">ID: {{ task.task_id }}</span>
        </div>
        <p class="task-progress">{{ task.progress }}</p>
        {% if task.error %}
            <p class="task-error">–û—à–∏–±–∫–∞: {{ task.error }}</p>
        {% endif %}
    </header>

    <section class="task-meta">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞</h2>
        <div class="meta-grid">
            <div>
                <span class="meta-label">–ö–æ–º–ø–∞–Ω–∏—è</span>
            <span class="meta-value">{{ task.source_info.company_name }}</span>
            </div>
            <div>
                <span class="meta-label">–°–∞–π—Ç</span>
                <span class="meta-value">{{ task.source_info.company_site }}</span>
            </div>
            <div>
                <span class="meta-label">–ò—Å—Ç–æ—á–Ω–∏–∫</span>
                <span class="meta-value">{{ task.source_info.source|upper }}</span>
            </div>
            <div>
                <span class="meta-label">–û–±–ª–∞—Å—Ç—å –ø–æ–∏—Å–∫–∞</span>
                <span class="meta-value">
                    {% if task.source_info.search_scope == "city" %}
                        –ì–æ—Ä–æ–¥: {{ task.source_info.location or "–Ω–µ —É–∫–∞–∑–∞–Ω–æ" }}
                    {% else %}
                        –°—Ç—Ä–∞–Ω–∞ / –æ–±—â–∏–π –ø–æ–∏—Å–∫
                    {% endif %}
                </span>
            </div>
        </div>
    </section>

    <section class="task-summary">
        <h2>–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h2>
        {% if statistics %}
            <table class="summary-table">
                <tbody>
                {% for key, label in summary_fields %}
                    <tr>
                        <th>{{ label }}</th>
                        <td>{{ statistics.get(key, "‚Äî") if statistics.get(key) not in (None, "") else "‚Äî" }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="muted">–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</p>
        {% endif %}
    </section>

    <section class="task-cards">
        <div class="section-heading">
            <h2>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</h2>
            <span class="badge">{{ cards|length }}</span>
        </div>

        {% if cards %}
            {% for card in cards %}
                <details class="card-panel">
                    <summary>
                        <div>
                            <h3>{{ card.get('card_name') or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</h3>
                            <p class="card-address">{{ card.get('card_address') or "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω" }}</p>
                        </div>
                        <div class="card-summary-stats">
                            <span>‚≠ê {{ card.get('card_rating') or "‚Äî" }}</span>
                            <span>üí¨ {{ card.get('card_reviews_count') or 0 }}</span>
                            {% if card.get('card_response_status') %}
                                <span>üó® {{ card.get('card_response_status') }}</span>
                            {% endif %}
                        </div>
                    </summary>
                    <div class="card-details-grid">
                        <div>
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ card.get('card_phone') or "‚Äî" }}</p>
                            <p><strong>–°–∞–π—Ç:</strong>
                                {% if card.get('card_website') %}
                                    <a href="{{ card.get('card_website') }}" target="_blank" rel="noopener">{{ card.get('card_website') }}</a>
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </p>
                            <p><strong>–†—É–±—Ä–∏–∫–∏:</strong> {{ card.get('card_rubrics') or "‚Äî" }}</p>
                        </div>
                        <div>
                            <p><strong>–û—Ç–≤–µ—Ç—ã:</strong> 
                                {% if card.get('card_answered_reviews_count') is not none %}
                                    –û—Ç–≤–µ—á–µ–Ω–æ: {{ card.get('card_answered_reviews_count', 0) }} / {{ card.get('card_reviews_count', 0) }}
                                {% else %}
                                    {{ card.get('card_response_status') or "–Ω–µ —É–∫–∞–∑–∞–Ω–æ" }}
                                {% endif %}
                            </p>
                            <p><strong>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</strong>
                                {% if card.get('card_avg_response_time') %}
                                    {{ card.get('card_avg_response_time') }} –¥–Ω.
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </p>
                            <p><strong>–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (4-5‚≠ê):</strong> {{ card.get('card_reviews_positive') or 0 }}</p>
                            <p><strong>–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (1-3‚≠ê):</strong> {{ card.get('card_reviews_negative') or 0 }}</p>
                        </div>
                    </div>
                    {% set reviews = card.get('detailed_reviews') %}
                    {% if reviews %}
                        <div class="reviews-block">
                            <h4>–û—Ç–∑—ã–≤—ã ({{ reviews|length }})</h4>
                            <ul class="review-list" style="list-style: none; padding: 0;">
                                {% for review in reviews %}
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                            {% if review.review_rating and review.review_rating|float > 0 %}
                                                {% set rating = review.review_rating|float %}
                                                {% set stars = "" %}
                                                {% if rating >= 4.5 %}
                                                    {% set stars = "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê" %}
                                                {% elif rating >= 4.0 %}
                                                    {% set stars = "‚≠ê‚≠ê‚≠ê‚≠ê" %}
                                                {% elif rating >= 3.5 %}
                                                    {% set stars = "‚≠ê‚≠ê‚≠ê" %}
                                                {% elif rating >= 3.0 %}
                                                    {% set stars = "‚≠ê‚≠ê‚≠ê" %}
                                                {% elif rating >= 2.5 %}
                                                    {% set stars = "‚≠ê‚≠ê" %}
                                                {% elif rating >= 2.0 %}
                                                    {% set stars = "‚≠ê‚≠ê" %}
                                                {% elif rating >= 1.5 %}
                                                    {% set stars = "‚≠ê" %}
                                                {% elif rating >= 1.0 %}
                                                    {% set stars = "‚≠ê" %}
                                                {% endif %}
                                                <span style="font-size: 1.1em;">{{ stars }}</span>
                                                <span style="font-size: 0.9em; color: #666;">({{ "%.1f"|format(rating) }})</span>
                                            {% endif %}
                                            {% if review.review_author %}
                                                <span style="font-size: 0.9em; color: #555; font-weight: 500;">{{ review.review_author }}</span>
                                            {% endif %}
                                            {% if review.review_date %}
                                                <span style="font-size: 0.85em; color: #888;">{{ review.review_date }}</span>
                                            {% endif %}
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% elif card.get('card_reviews_count', 0) > 0 %}
                        <div class="reviews-block">
                            <p class="muted">–û—Ç–∑—ã–≤—ã –Ω–∞–π–¥–µ–Ω—ã ({{ card.get('card_reviews_count', 0) }}), –Ω–æ –¥–µ—Ç–∞–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</p>
                        </div>
                    {% endif %}
                </details>
            {% endfor %}
        {% else %}
            <p class="muted">–ö–∞—Ä—Ç–æ—á–∫–∏ –µ—â—ë –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
        {% endif %}
    </section>

    <section class="task-files">
        <h2>–§–∞–π–ª—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
        {% if task.result_file %}
            <p>CSV —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ <code>{{ task.result_file }}</code> –≤ –ø–∞–ø–∫–µ <code>{{ output_dir }}</code>.</p>
        {% else %}
            <p class="muted">–§–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω.</p>
        {% endif %}
        <p>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞: <strong>{{ task.email }}</strong></p>
    </section>
</div>
</body>
</html>